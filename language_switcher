#!/usr/bin/env bash

# Получаем выделенный текст из Primary буфера (последний выделенный текст)
TEXT=$(xsel -p -o)

# Проверяем, что текст не пустой
if [ -z "$TEXT" ]; then
    notify-send "Не удалось получить выделенный текст. Убедитесь, что что-то выделено."
    exit 1
fi

# Функция для переключения раскладки
transform_text() {
    local text="$1"
    local transformed=""
    local char
    local i

    # Массивы соответствий
    declare -A en_to_ru=( ["q"]="й" ["w"]="ц" ["e"]="у" ["r"]="к" ["t"]="е" ["y"]="н" ["u"]="г" ["i"]="ш" ["o"]="щ" ["p"]="з" ["["]="х" ["]"]="ъ"
                          ["a"]="ф" ["s"]="ы" ["d"]="в" ["f"]="а" ["g"]="п" ["h"]="р" ["j"]="о" ["k"]="л" ["l"]="д" [";"]="ж" ["'"]="э"
                          ["z"]="я" ["x"]="ч" ["c"]="с" ["v"]="м" ["b"]="и" ["n"]="т" ["m"]="ь" [","]="б" ["."]="ю" ["/"]="/"
                          ["Q"]="Й" ["W"]="Ц" ["E"]="У" ["R"]="К" ["T"]="Е" ["Y"]="Н" ["U"]="Г" ["I"]="Ш" ["O"]="Щ" ["P"]="З" ["{"]="Х" ["}"]="Ъ"
                          ["A"]="Ф" ["S"]="Ы" ["D"]="В" ["F"]="А" ["G"]="П" ["H"]="Р" ["J"]="О" ["K"]="Л" ["L"]="Д" [":"]="Ж" ["\""]="Э"
                          ["Z"]="Я" ["X"]="Ч" ["C"]="С" ["V"]="М" ["B"]="И" ["N"]="Т" ["M"]="Ь" ["<"]="Б" [">"]="Ю" ["?"]=","
    )

    declare -A ru_to_en=( ["й"]="q" ["ц"]="w" ["у"]="e" ["к"]="r" ["е"]="t" ["н"]="y" ["г"]="u" ["ш"]="i" ["щ"]="o" ["з"]="p" ["х"]="[" ["ъ"]="]"
                          ["ф"]="a" ["ы"]="s" ["в"]="d" ["а"]="f" ["п"]="g" ["р"]="h" ["о"]="j" ["л"]="k" ["д"]="l" ["ж"]=";" ["э"]="'"
                          ["я"]="z" ["ч"]="x" ["с"]="c" ["м"]="v" ["и"]="b" ["т"]="n" ["ь"]="m" ["б"]="," ["ю"]="." [","]="/"
                          ["Й"]="Q" ["Ц"]="W" ["У"]="E" ["К"]="R" ["Е"]="T" ["Н"]="Y" ["Г"]="U" ["Ш"]="I" ["Щ"]="O" ["З"]="P" ["Х"]="{"
                          ["Ъ"]="}" ["Ф"]="A" ["Ы"]="S" ["В"]="D" ["А"]="F" ["П"]="G" ["Р"]="H" ["О"]="J" ["Л"]="K" ["Д"]="L"
                          ["Ж"]=":" ["Э"]="\"" ["Я"]="Z" ["Ч"]="X" ["С"]="C" ["М"]="V" ["И"]="B" ["Т"]="N" ["Ь"]="M" ["Б"]="<"
                          ["Ю"]=">" ["?"]="/"
    )

    for (( i=0; i<${#text}; i++ )); do
        char="${text:$i:1}"
        if [[ ${ru_to_en[$char]} ]]; then
            transformed+="${ru_to_en[$char]}"
        elif [[ ${en_to_ru[$char]} ]]; then
            transformed+="${en_to_ru[$char]}"
        else
            transformed+="$char"
        fi
    done

    echo "$transformed"
}

# Преобразуем текст
TRANSFORMED_TEXT=$(transform_text "$TEXT")


# Помещаем преобразованный текст в буфер обмена и Primary буфер
echo -n "$TRANSFORMED_TEXT" | xsel -b -i   # Копируем в Clipboard
echo -n "$TRANSFORMED_TEXT" | xsel -p -i   # Копируем в Primary

# Добавляем небольшую задержку перед вставкой
sleep 0.2  # Задержка в 0.2 секунды (можно увеличить, если требуется больше времени)

# Вставляем преобразованный текст в активное окно с помощью xdotool
xdotool key --clearmodifiers "ctrl+v"

# Сброс всех возможных застрявших клавиш-модификаторов
xdotool keyup ctrl shift alt super

# Очищаем буферы обмена
xsel -c -b  # Очистка Clipboard буфера
xsel -c -p  # Очистка Primary буфера

